<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cow Configurator (Web Serial)</title>
  <meta name="cow-configurator-version" content="v1.1.0">
  <style>
:root {
  --bg: #0b0f14;
  --bg-grad-1: #0b0f14;
  --bg-grad-2: #0e131a;
  --panel: #121822;
  --panel-2: #151d28;
  --border: #223043;
  --border-2: #2a3a52;
  --text: #e6eaf0;
  --text-muted: #9aa7b8;
  --text-soft: #7b8796;
  --accent: #3b82f6;   /* blue */
  --accent-2: #22d3ee; /* cyan */
  --success: #22c55e;
  --warning: #f59e0b;
  --error: #ef4444;
  --shadow: 0 6px 24px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.25);
}
* { box-sizing: border-box; }
html { font-size: 62.5%; }
body {
  margin: 0;
  min-height: 100vh;
  font: 500 1.6rem -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
  color: var(--text);
  background: radial-gradient(1200px 800px at 10% 0%, rgba(34,197,94,0.04), transparent 50%),
              radial-gradient(1000px 600px at 100% 20%, rgba(59,130,246,0.06), transparent 60%),
              linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2));
}
.container {
  max-width: 980px;
  margin: 32px auto 120px;
  padding: 0 24px;
}
/* Top Bar */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  background: linear-gradient(180deg, var(--panel), var(--panel-2));
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: var(--shadow);
}
.topbar .brand {
  display: flex; align-items: center; gap: 12px;
}
.topbar .brand h1 {
  font-size: 2.0rem; margin: 0; letter-spacing: 0.4px; font-weight: 700;
}
.version-chip {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border-2);
  background: #0f1724; color: var(--text-soft);
  font-size: 1.3rem; line-height: 1;
}
.topbar .actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }

/* Panel */
.panel {
  margin-top: 16px;
  background: linear-gradient(180deg, var(--panel), var(--panel-2));
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  box-shadow: var(--shadow);
}

/* Typography tweaks */
h2, h3, h4, h5, h6 { color: var(--text); margin: 0 0 12px; }
label {
  display: block; margin-bottom: 6px; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.04em; font-size: 1.2rem;
}

/* Form layout */
.row { display: flex; align-items: center; gap: 14px; margin: 10px 0; }
.row > label { flex: 1 0 160px; }
.row > input, .row > #addressBox { flex: 2 0 220px; }

/* Inputs */
input, textarea, select {
  width: 100%;
  height: 42px;
  background: #0b1118;
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 12px;
  outline: none;
  transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
}
input:focus, textarea:focus, select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
}
input.readonly { color: var(--text-soft); background: #0a0f15; }

/* Number input tweaks */
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; appearance: textfield; }

/* Address box */
#addressBox { display: flex; align-items: center; gap: 8px; white-space: nowrap; }
#addressBox input[type=number] { width: 6.4em; min-width: 5.2em; text-align: center; }
#addressMatchLabel { padding: 4px 8px; border-radius: 999px; font-weight: 700; }

/* Buttons */
.btn, button {
  appearance: none;
  display: inline-flex; align-items: center; justify-content: center;
  gap: 8px; padding: 10px 16px;
  color: #0b0f14; background: #e6eaf0;
  border: 1px solid var(--border-2);
  border-radius: 10px;
  cursor: pointer; font-weight: 700; letter-spacing: 0.02em;
  transition: transform .06s ease, background .2s ease, color .2s ease, border-color .2s ease, box-shadow .2s ease;
}
.btn:hover { transform: translateY(-1px); box-shadow: 0 8px 22px rgba(0,0,0,0.35); }
.btn:active { transform: translateY(0); box-shadow: none; }
.btn-primary {
  background: linear-gradient(180deg, var(--accent), #2563eb);
  color: #ffffff; border-color: #1f4fd1;
}
.btn-primary:hover { background: linear-gradient(180deg, #4f8df9, #2d6df0); }
.btn-outline { background: transparent; color: var(--text); border-color: var(--border-2); }
.btn-outline:hover { background: #0f1724; }
.btn-ghost { background: transparent; color: var(--text-soft); border-color: transparent; }
.btn-ghost:hover { color: var(--text); background: rgba(148,163,184,0.08); }

.btn-row { display: flex; flex-wrap: wrap; gap: 10px; margin: 14px 0 4px; }

/* Links */
a { color: #a8c7ff; text-decoration: none; }
a:hover { color: #d0e1ff; text-decoration: underline; text-underline-offset: 2px; }

/* Messages */
#msg {
  margin-top: 12px; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border);
  background: #0b1118; color: var(--text);
}
#msg.success { border-color: rgba(34,197,94,0.45); background: rgba(34,197,94,0.08); color: #a7f3d0; }
#msg.error   { border-color: rgba(239,68,68,0.45); background: rgba(239,68,68,0.08); color: #fecaca; }

/* Floating controls & footer */
#offlineRow {
  position: fixed; bottom: 24px; right: 32px; z-index: 1000;
  display: flex; align-items: center; gap: 10px; margin: 0;
}
#versionFooter { position: fixed; bottom: 16px; left: 24px; color: var(--text-soft); font-size: 1.2rem; z-index: 1000; }

/* Small screens */
@media (max-width: 720px) {
  .row { flex-direction: column; align-items: stretch; }
  .row > label { flex: 0 0 auto; width: 100%; }
  .row > input, .row > #addressBox { flex: 1 1 auto; width: 100%; }
  .topbar { align-items: flex-start; }
  .topbar .actions { width: 100%; justify-content: space-between; }
}
  </style>
</head>
<body>
  <div class="container">
    <!-- Top bar replacing the old heading/connect/version block -->
    <div class="topbar">
      <div class="brand">
        <h1>Cow USB Configurator</h1>
      </div>
      <div class="actions">
        <span class="version-chip" id="versionLabel">Version: Not connected</span>
        <button id="connectBtn" class="btn btn-primary" type="button">Connect</button>
      </div>
    </div>

    <div class="panel">
      <form id="configForm" autocomplete="off">
        <div class="row" style="display: flex; align-items: flex-start; gap: 0em; flex-direction: column;">
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="address_3" style="flex: 1 0 140px; text-align: left;">address</label>
              <div id="addressBox" style="display: flex; gap: 0.5em; flex: 2 0 180px; align-items: center; width: 100%; white-space: nowrap;">
                  <input id="address_0" type="number" min="0" value="67" style="display:none;" title="Address byte 1 (fixed)">
                  <input id="address_1" type="number" min="0" value="79" style="display:none;" title="Address byte 2 (fixed)">
                  <input id="address_2" type="number" min="0" value="87" style="display:none;" title="Address byte 3 (fixed)">
                  <input id="address_3" type="number" min="0" value="0" title="Address byte 4 (configurable)">
                  <input id="address_4" type="number" min="0" value="0" title="Address byte 5 (configurable)">
                  <span id="addressMatchLabel" style="left:0.em; color:#4caf50; font-size:1em; font-weight:600; padding:0 0.2em;"></span>
            </div>
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="max_drive" style="flex: 1 0 140px;">Max Drive</label>
            <input id="max_drive" type="number" min="0" value="1000" style="flex: 2 0 180px;" title="Maximum drive speed (0-1000)">
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="max_turn" style="flex: 1 0 140px;">Max Turn</label>
            <input id="max_turn" type="number" min="0" value="500" style="flex: 2 0 180px;" title="Maximum turning speed (0-1000)">
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="max_cow" style="flex: 1 0 140px;">Max Cow</label>
            <input id="max_cow" type="number" min="0" value="500" style="flex: 2 0 180px;" title="Maximum cow factor (0-1000)">
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="accel" style="flex: 1 0 140px;">Acceleration</label>
            <input id="accel" type="number" step="0.01" value="0.06" style="flex: 2 0 180px;" title="Acceleration rate (0-1)">
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="deccel" style="flex: 1 0 140px;">Deceleration</label>
            <input id="deccel" type="number" step="0.01" value="0.04" style="flex: 2 0 180px;" title="Deceleration rate (0-1)">
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="cow_factor" style="flex: 1 0 140px;">Cow Factor</label>
            <input id="cow_factor" type="number" step="0.01" value="0.25" style="flex: 2 0 180px;" title="Cow factor (0-1, affects movement)">
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="working_hour" style="flex: 1 0 140px;">Hour Meter</label>
            <input id="working_hour" class="readonly" type="text" readonly value="0.00 h" style="flex: 2 0 180px;" title="Total working hours (read-only)">
          </div>
          <div style="display: flex; align-items: center; width: 100%; gap: 1em;">
            <label for="time_out" style="flex: 1 0 140px;">Fail Safe</label>
            <input id="time_out" type="number" min="0" value="2000" style="flex: 2 0 180px;" title="Timeout in milliseconds (e.g. 2000 = 2 seconds)">
          </div>
        </div>
        <div class="btn-row">
          <button type="button" id="saveBtn" class="btn btn-primary">Upload to Board</button>
          <button type="button" id="loadBtn" class="btn">Load from Board</button>
          <button type="button" id="resetBtn" class="btn">Default Reset</button>
        </div>
        <div class="btn-row">
          <button type="button" id="exportBtn" class="btn">Save Config to PC</button>
          <button type="button" id="importBtn" class="btn">Load Config from PC</button>
        </div>
      </form>
      <div id="msg"></div>
    </div>

    <div id="browserWarning" style="display:none; color: #ff9800; font-weight: bold; margin-bottom: 1em;"></div>
    <div id="offlineRow" style="position: fixed; bottom: 24px; right: 32px; z-index: 1000; display: flex; align-items: center; gap: 1em; margin-bottom: 0;">
      <button id="openFlasherBtn" type="button" class="btn btn-outline" style="display:none;">Open Flasher</button>
      <button id="downloadOfflineBtn" type="button" class="btn btn-ghost">Download for Offline Use</button>
      <span id="offlineLabel" style="display:none; color: #4caf50; font-weight: bold;">Working Offline</span>
      <button id="checkUpdateBtn" type="button" class="btn btn-ghost" style="display:none;">Check for Update</button>
    </div>
    <div id="versionFooter" style="position: fixed; bottom: 16px; left: 24px; color: var(--text-soft); font-size: 1.2rem; z-index: 1000;">Version:</div>
  </div>
  <input type="file" id="importFile" accept=".json" style="display:none">
  <p style="margin-top:1em; color:#4caf50; background:#222; padding:1.1em; border-radius:6px;">
    <strong>Note:</strong> For quick setup, use these address values:<br>
    <b>Cow 1 address:</b> <code id="cow1_addr">65 68</code>
    <button type="button" style="margin-left:0.7em;" onclick="setAddress([67,79,87,65,68])">Use</button><br>
    <b>Cow 2 address:</b> <code id="cow2_addr">51 49</code>
    <button type="button" style="margin-left:0.7em;" onclick="setAddress([67,79,87,51,49])">Use</button>
  </p>
  <p style="margin-top:1em; color:#ff9800; background:#333; padding:1em; border-radius:6px;">
    <strong>Having trouble connecting or with USB drivers?</strong><br>
    You can use <a href="https://zadig.akeo.ie/#google_vignette" target="_blank" style="color:#ffd700; text-decoration:underline;">Zadig</a> to install or update your USB drivers. Visit the Zadig website for more information and downloads.<br>
    
  </p>
  <script>
    // Helper to set address fields from quick setup buttons
    function setAddress(arr) {
      for (let i = 0; i < 5; ++i) {
        const el = document.getElementById('address_' + i);
        if (el) el.value = arr[i];
      }
      updateAddressMatchLabel();
    }

    function updateAddressMatchLabel() {
      const cow1 = [67,79,87,65,68];
      const cow2 = [67,79,87,51,49];
      let addr = [];
      for (let i = 0; i < 5; ++i) {
        const el = document.getElementById('address_' + i);
        addr.push(parseInt(el.value, 10));
      }
      const label = document.getElementById('addressMatchLabel');
      if (addr.every((v,i)=>v===cow1[i])) {
        label.textContent = 'Cow 1';
        label.style.color = '#4caf50';
      } else if (addr.every((v,i)=>v===cow2[i])) {
        label.textContent = 'Cow 2';
        label.style.color = '#ff9800';
      } else {
        label.textContent = '';
      }
    }

    // Attach input listeners to address fields
    window.addEventListener('DOMContentLoaded', function() {
      // Set default values for hidden address fields
      document.getElementById('address_0').value = 67;
      document.getElementById('address_1').value = 79;
      document.getElementById('address_2').value = 87;
      
      for (let i = 0; i < 5; ++i) {
        const el = document.getElementById('address_' + i);
        if (el) el.addEventListener('input', updateAddressMatchLabel);
      }
      updateAddressMatchLabel();
    });
    // --- Web Serial API helpers ---
    let port = null;
    let reader = null;
    let writer = null;
    let connected = false;

    const connectBtn = document.getElementById('connectBtn');
    const versionLabel = document.getElementById('versionLabel');
    const msgDiv = document.getElementById('msg');
    const workingHourInput = document.getElementById('working_hour');
    const downloadOfflineBtn = document.getElementById('downloadOfflineBtn');
    const offlineLabel = document.getElementById('offlineLabel');
    const checkUpdateBtn = document.getElementById('checkUpdateBtn');
    const openFlasherBtn = document.getElementById('openFlasherBtn');

    const fields = [
      'address_0','address_1','address_2','address_3','address_4',
      'max_drive','max_turn','max_cow','accel','deccel','cow_factor','working_hour','time_out'
    ];

    connectBtn.onclick = async () => {
      if (!connected) {
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });
          writer = port.writable.getWriter();
          reader = port.readable.getReader();
          connected = true;
          connectBtn.textContent = 'Disconnect';
          versionLabel.textContent = 'Version: Connecting...';
          showMsg('Connected to serial port.', 'success');
          openFlasherBtn.style.display = '';
          // Identify device
          const lines = await sendCmd('IDENTIFY', true);
          if (lines.length && lines[0].startsWith('COW_ROBOT_V')) {
            versionLabel.textContent = 'Version: ' + lines[0];
            showMsg('Device identified.', 'success');
            await loadFromDevice();
          } else {
            versionLabel.textContent = 'Version: Not connected';
            showMsg('Wrong device or no response.', 'error');
            openFlasherBtn.style.display = 'none';
            await disconnectSerial();
          }
        } catch (e) {
          showMsg('Connection error: ' + e, 'error');
          openFlasherBtn.style.display = 'none';
          await disconnectSerial();
        }
      } else {
        await disconnectSerial();
      }
    };

    async function disconnectSerial() {
      if (reader) { try { await reader.cancel(); } catch {} reader = null; }
      if (writer) { try { writer.releaseLock(); } catch {} writer = null; }
      if (port) { try { await port.close(); } catch {} port = null; }
      connected = false;
      connectBtn.textContent = 'Connect';
      versionLabel.textContent = 'Version: Not connected';
      showMsg('Disconnected.', 'success');
      openFlasherBtn.style.display = 'none';
      // Reset all input values to 0 on disconnect (except working_hour and fixed address bytes)
      const inputFields = [
        'address_3','address_4',
        'max_drive','max_turn','max_cow','accel','deccel','cow_factor','time_out'
      ];
      inputFields.forEach(f => {
        const el = document.getElementById(f);
        if (el) el.value = 0;
      });
      // Keep the fixed address values
      document.getElementById('address_0').value = 67;
      document.getElementById('address_1').value = 79;
      document.getElementById('address_2').value = 87;
      const workingHourInput = document.getElementById('working_hour');
      if (workingHourInput) workingHourInput.value = '0.00 h';
    }

    async function sendCmd(cmd, waitResponse=false) {
      if (!connected || !writer) { showMsg('Not connected to serial.', 'error'); return []; }
      const framed = `@${cmd};\r\n`;
      await writer.write(new TextEncoder().encode(framed));
      await delay(100); // Add delay after every command
      if (!waitResponse) return [];
      // Read lines until timeout or empty line
      let lines = [];
      let timeout = 1000; // ms
      let start = Date.now();
      let buffer = '';
      while (Date.now() - start < timeout) {
        try {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += new TextDecoder().decode(value);
          let idx;
          while ((idx = buffer.indexOf('\n')) !== -1) {
            let line = buffer.slice(0, idx).replace(/\r/g, '').trim();
            buffer = buffer.slice(idx+1);
            if (line) lines.push(line);
          }
          if (lines.length > 0 && buffer === '') break;
        } catch (e) { break; }
      }
      return lines;
    }

    async function loadFromDevice() {
      if (!connected) { showMsg('Not connected.', 'error'); return; }
      await sendCmd('LOAD');
      const lines = await sendCmd('DUMP', true);
      if (!lines.length) { showMsg('No response from device.', 'error'); return; }
      lines.forEach(line => {
        if (line.startsWith('ADDR=')) {
          const addr = line.split('=')[1].split(':');
          for (let i=0; i<5; ++i) document.getElementById(`address_${i}`).value = parseInt(addr[i], 16);
        } else if (line.includes('=')) {
          let [key, value] = line.split('=', 2);
          key = key.toLowerCase();
          if (key === 'working_hour') {
            let totalMin = parseInt(value);
            let hours = (totalMin/60).toFixed(2) + ' h';
            workingHourInput.value = hours;
          } else if (fields.includes(key)) {
            document.getElementById(key).value = value;
          }
        }
      });
      updateAddressMatchLabel();
      showMsg('Configuration loaded.', 'success');
    }

    document.getElementById('saveBtn').onclick = async () => {
      if (!connected) { showMsg('Not connected.', 'error'); return; }
      try {
        let addr = [];
        for (let i=0; i<5; ++i) addr.push(parseInt(document.getElementById(`address_${i}`).value));
        // Validate max_drive, max_turn, max_cow
        const maxDrive = parseInt(document.getElementById('max_drive').value);
        const maxTurn = parseInt(document.getElementById('max_turn').value);
        const maxCow = parseInt(document.getElementById('max_cow').value);
        // Validate accel, deccel, cow_factor
        const accel = parseFloat(document.getElementById('accel').value);
        const deccel = parseFloat(document.getElementById('deccel').value);
        const cowFactor = parseFloat(document.getElementById('cow_factor').value);
        let invalidFields = [];
        if (isNaN(maxDrive) || maxDrive < 0 || maxDrive > 1000) invalidFields.push('max_drive');
        if (isNaN(maxTurn) || maxTurn < 0 || maxTurn > 1000) invalidFields.push('max_turn');
        if (isNaN(maxCow) || maxCow < 0 || maxCow > 1000) invalidFields.push('max_cow');
        if (isNaN(accel) || accel < 0 || accel > 1) invalidFields.push('accel');
        if (isNaN(deccel) || deccel < 0 || deccel > 1) invalidFields.push('deccel');
        if (isNaN(cowFactor) || cowFactor < 0 || cowFactor > 1) invalidFields.push('cow_factor');
        if (invalidFields.length > 0) {
          let msg = '';
          let rangeMsg = [];
          if (invalidFields.includes('max_drive') || invalidFields.includes('max_turn') || invalidFields.includes('max_cow')) {
            rangeMsg.push('max_drive, max_turn, max_cow: 0-1000');
          }
          if (invalidFields.includes('accel') || invalidFields.includes('deccel') || invalidFields.includes('cow_factor')) {
            rangeMsg.push('0-1');
          }
          msg = 'Values for ' + invalidFields.join(', ') + ' must be in range: ' + rangeMsg.join('; ');
          showMsg(msg, 'error');
          return;
        }
        await sendCmd(`ADDR=${addr.join(':')}`);
        await sendCmd(`MAX_DRIVE=${maxDrive}`);
        await sendCmd(`MAX_TURN=${maxTurn}`);
        await sendCmd(`MAX_COW=${maxCow}`);
        await sendCmd(`ACCEL=${accel}`);
        await sendCmd(`DECCEL=${deccel}`);
        await sendCmd(`COW_FACTOR=${cowFactor}`);
        await sendCmd(`TIME_OUT=${parseInt(document.getElementById('time_out').value)}`);
        await sendCmd('SAVE');
        showMsg('Configuration saved to STM32 flash.', 'success');
      } catch (e) {
        showMsg('Failed to send/save: ' + e, 'error');
      }
    };

    document.getElementById('loadBtn').onclick = loadFromDevice;

    document.getElementById('resetBtn').onclick = async () => {
      if (!connected) { showMsg('Not connected.', 'error'); return; }
      await sendCmd('RESET');
      showMsg('Device reset command sent.', 'success');
      // Reload values from device after reset
      await loadFromDevice();
    };

    document.getElementById('exportBtn').onclick = () => {
      let data = {};
      fields.forEach(f => { data[f] = document.getElementById(f).value; });
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'stm32_config.json';
      a.click();
      URL.revokeObjectURL(url);
      showMsg('Configuration exported.', 'success');
    };

    document.getElementById('importBtn').onclick = () => {
      document.getElementById('importFile').click();
    };
    document.getElementById('importFile').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const data = JSON.parse(ev.target.result);
          fields.forEach(f => {
            if (data[f] !== undefined) document.getElementById(f).value = data[f];
          });
          showMsg('Configuration imported.', 'success');
        } catch (e) {
          showMsg('Failed to import: ' + e, 'error');
        }
      };
      reader.readAsText(file);
    };

    downloadOfflineBtn.onclick = () => {
      // Download only the current HTML file for offline use
      const a = document.createElement('a');
      a.href = window.location.href;
      a.download = 'Cow_USB_Configurator.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    };

    checkUpdateBtn.onclick = async () => {
      // Change this URL to your latest HTML file location (e.g., GitHub raw link)
      const latestUrl = 'https://raw.githubusercontent.com/EmbeddedEra/The_Real_Cow_Configurator/refs/heads/main/index.html';
      const currentVersion = getVersionFromMeta(document);
      showMsg('Checking for update... (Current: ' + currentVersion + ')', '');
      try {
        const response = await fetch(latestUrl, {cache: 'no-store'});
        if (!response.ok) throw new Error('Could not fetch latest version');
        const latestHtml = await response.text();
        // Parse version from fetched HTML
        const parser = new DOMParser();
        const latestDoc = parser.parseFromString(latestHtml, 'text/html');
        const latestVersion = getVersionFromMeta(latestDoc);
        if (!latestVersion) throw new Error('No version found in latest file');
        if (currentVersion === latestVersion) {
          showMsg('You already have the latest version (' + currentVersion + ').', 'success');
          // Do not download if offline and already up to date
          return;
        }
        showMsg('New version available! Current: ' + currentVersion + ', Latest: ' + latestVersion, '');
        // Offer to download if different
        const blob = new Blob([latestHtml], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Cow_USB_Configurator.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        showMsg('Latest version (' + latestVersion + ') downloaded.', 'success');
      } catch (e) {
        showMsg('Could not check for update: ' + e, 'error');
      }
    };

    function getVersionFromMeta(doc) {
      const meta = doc.querySelector('meta[name="cow-configurator-version"]');
      return meta ? meta.getAttribute('content') : '';
    }

    function showMsg(msg, type) {
      msgDiv.textContent = msg;
      msgDiv.className = type;
    }

    // Add this helper function near the top of your <script>
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

    // On load
    window.onload = async () => {
      // Browser check for Web Serial API (best in Chrome/Edge)
      const browserWarning = document.getElementById('browserWarning');
      const isChrome = /Chrome\//.test(navigator.userAgent) && /Google Inc\./.test(navigator.vendor);
      const isEdge = /Edg\//.test(navigator.userAgent);
      if (!isChrome && !isEdge) {
        browserWarning.style.display = '';
        browserWarning.textContent = 'Warning: This app works best in Google Chrome or Microsoft Edge.';
      }
      if (!('serial' in navigator)) {
        showMsg('This app works best in Google Chrome or Microsoft Edge.', 'error');
        connectBtn.disabled = true;
        return;
      }
      // Set all input values to 0 on page load (except working_hour and fixed address bytes)
      const inputFields = [
        'address_3','address_4',
        'max_drive','max_turn','max_cow','accel','deccel','cow_factor','time_out'
      ];
      inputFields.forEach(f => {
        const el = document.getElementById(f);
        if (el) el.value = 0;
      });
      // Set the fixed address values
      document.getElementById('address_0').value = 67;
      document.getElementById('address_1').value = 79;
      document.getElementById('address_2').value = 87;
      const workingHourInput = document.getElementById('working_hour');
      if (workingHourInput) workingHourInput.value = '0.00 h';
      // Show offline label and check update button if running from file:// and hide download button
      if (window.location.protocol === 'file:') {
        offlineLabel.style.display = '';
        downloadOfflineBtn.style.display = 'none';
        checkUpdateBtn.style.display = '';
      }
      // Update version in footer from meta tag
      const versionFooter = document.getElementById('versionFooter');
      const metaVersion = document.querySelector('meta[name="cow-configurator-version"]');
      if (versionFooter && metaVersion) {
        versionFooter.textContent = 'Version: ' + metaVersion.getAttribute('content');
      }
    };

    openFlasherBtn.onclick = async () => {
      if (!connected) { showMsg('Not connected.', 'error'); return; }
      try {
        // Re-acquire writer and reader if needed
        if (!writer && port && port.writable) writer = port.writable.getWriter();
        if (!reader && port && port.readable) reader = port.readable.getReader();
        await sendCmd('BOOT_LOADER', false);
        setTimeout(async () => {
          await disconnectSerial();
          window.open('https://embeddedera.github.io/The_Real_Cow_Flasher/', '_blank');
        }, 500); // Give device time to enter bootloader
      } catch (e) {
        showMsg('Failed to send BOOT_LOADER: ' + e, 'error');
      }
    };
  </script>
</body>
</html>
